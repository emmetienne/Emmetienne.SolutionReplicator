using System;
using System.Collections.Generic;
using System.ComponentModel.Composition;
using System.IO;
using System.Linq;
using System.Reflection;
using XrmToolBox.Extensibility;
using XrmToolBox.Extensibility.Interfaces;

namespace Emmetienne.SolutionReplicator
{
    // Do not forget to update version number and author (company attribute) in AssemblyInfo.cs class
    // To generate Base64 string for Images below, you can use https://www.base64-image.de/
    [Export(typeof(IXrmToolBoxPlugin)),
        ExportMetadata("Name", "Solution replicator"),
        ExportMetadata("Description", "Creates a copycat solution on a target environment using as a reference another solution form a source environtment."),
        // Please specify the base64 content of a 32x32 pixels image
        ExportMetadata("SmallImageBase64", "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"),
        // Please specify the base64 content of a 80x80 pixels image
        ExportMetadata("BigImageBase64", "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"),
        ExportMetadata("BackgroundColor", "Lavender"),
        ExportMetadata("PrimaryFontColor", "Black"),
        ExportMetadata("SecondaryFontColor", "Gray")]
    public class MyPlugin : PluginBase
    {
        public override IXrmToolBoxPluginControl GetControl()
        {
            return new SolutionReplicatorControl();
        }

        /// <summary>
        /// Constructor 
        /// </summary>
        public MyPlugin()
        {
            // If you have external assemblies that you need to load, uncomment the following to 
            // hook into the event that will fire when an Assembly fails to resolve
            // AppDomain.CurrentDomain.AssemblyResolve += new ResolveEventHandler(AssemblyResolveEventHandler);
        }

        /// <summary>
        /// Event fired by CLR when an assembly reference fails to load
        /// Assumes that related assemblies will be loaded from a subfolder named the same as the Plugin
        /// For example, a folder named Sample.XrmToolBox.MyPlugin 
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="args"></param>
        /// <returns></returns>
        private Assembly AssemblyResolveEventHandler(object sender, ResolveEventArgs args)
        {
            Assembly loadAssembly = null;
            Assembly currAssembly = Assembly.GetExecutingAssembly();

            // base name of the assembly that failed to resolve
            var argName = args.Name.Substring(0, args.Name.IndexOf(","));

            // check to see if the failing assembly is one that we reference.
            List<AssemblyName> refAssemblies = currAssembly.GetReferencedAssemblies().ToList();
            var refAssembly = refAssemblies.Where(a => a.Name == argName).FirstOrDefault();

            // if the current unresolved assembly is referenced by our plugin, attempt to load
            if (refAssembly != null)
            {
                // load from the path to this plugin assembly, not host executable
                string dir = Path.GetDirectoryName(currAssembly.Location).ToLower();
                string folder = Path.GetFileNameWithoutExtension(currAssembly.Location);
                dir = Path.Combine(dir, folder);

                var assmbPath = Path.Combine(dir, $"{argName}.dll");

                if (File.Exists(assmbPath))
                {
                    loadAssembly = Assembly.LoadFrom(assmbPath);
                }
                else
                {
                    throw new FileNotFoundException($"Unable to locate dependency: {assmbPath}");
                }
            }

            return loadAssembly;
        }
    }
}