using System;
using System.Collections.Generic;
using System.ComponentModel.Composition;
using System.IO;
using System.Linq;
using System.Reflection;
using XrmToolBox.Extensibility;
using XrmToolBox.Extensibility.Interfaces;

namespace Emmetienne.SolutionReplicator
{
    // Do not forget to update version number and author (company attribute) in AssemblyInfo.cs class
    // To generate Base64 string for Images below, you can use https://www.base64-image.de/
    [Export(typeof(IXrmToolBoxPlugin)),
        ExportMetadata("Name", "Solution replicator"),
        ExportMetadata("Description", "Creates a copycat solution on a target environment using as a reference another solution form a source environtment."),
        // Please specify the base64 content of a 32x32 pixels image
        ExportMetadata("SmallImageBase64", "iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAARHRFWHRGaWxlAEM6XFVzZXJzXG1hcnR5XE9uZURyaXZlXERlc2t0b3BcUHJvamVjdHNcM2RcTG9nb1xtdG5fbG9nby5ibGVuZP/cSfgAAAAYdEVYdERhdGUAMjAyNC8wNi8yMyAxOTo1ODoxNu6MQSIAAAAQdEVYdFRpbWUAMDA6MDA6MDA6MDCbxBZUAAAACXRFWHRGcmFtZQAwMDC2ViW0AAAADXRFWHRDYW1lcmEAQ2FtZXJhaP/v6QAAAAt0RVh0U2NlbmUAU2NlbmXlIV2WAAAAE3RFWHRSZW5kZXJUaW1lADAwOjAwLjA10F2qzgAACGRJREFUWAltV1tsVNcVXffOeMYz9viBbTAPGz8wBQVMCCZ9kEoNUVSBkBKpH1SlqG1Eq1aNmo/2p6iR6Ec+qlZq2qqt1K9ESiuBo5CQqB+RQkkVEwgoNAEXB2xjj9/G9njssT3v27X3uWc8QI+Ze87dZ++91n6cey/Ozk1HPc8Dh1wcOI6seWeE5uahqyNKVP/SniaEKyvw2fUJ2jmP2DiOK56MtXGvOkQRKF0HBUgdikTU5V7X5l4J+cbW194nNuPpZ/ajvbOV+sDw06O40teP6x/HDZ4xFW/q85GLvy+4QRuNYlLfkOFsQcWaBgK0r2cLviHAHS3Y3NCAjh0diNTV4M7tAezoasNXDo2sE7GoPgePZCQw61+3Ba9r41FPCJXj6dpGwZvuh4C3NTejpr4egYoKBGNRwHVRyGZx+9YtjI1NYvCuT+RynH5thi0jM0tAgursJAHLzkRqDKQU+3q2MuLH0dbegq2NjdjqA7sVQUbiwgm6cINchyp87x4KuRwGbt5CvIzINRKRoeX0Ne3EDBxRLrYxZKP7gKT6caa6VVPdsnkzqmtrESCQSSEbrlhEsViAQzIVkUqSCVqfOuezGQzc6kc8PoHhwVF8zB65dnm0VALb5I6cAsm/sNAaHyYwm0tqLKmOSaolSqEvvVD0kE+nMU/Hb79xAX86exXvv/cKtvfs+78hCpEv+vsxOjqBIRIpNatP1xDgzQ9ffAa7H9uBCKPZWB1DR2cnQtGoAgtDr1BELp1R4HcEuPeqcaH545LkPhs6i8po1aNEvCKGBga0LKnlFPouXcf53htqr8ewpi7MqFtQVRUly0G89ekNvPjtE2jZvZPpjSCfyWJ+bAIX3ngXfzx3RY+qWEtWtH/84nZ3HBce+Hz4LMJV1Qogx2d1eRnDd77A3aE4ArkiVqZmdU/KYI6hOOOfCOLxMUxPT+NXr/5Oj94vvvt9fH6jH3958yrSq2Xh+nVTErSTWXlQ5eCe49jQ5OLcW3/G5Fgcp0+fQWJuHrFAGD27u5FdySiWYOopiNWFcPrXJ1DfuAvde7fix6d+oJEJTW0WOs3lPCwtAgv3i8isKmMlaEEl9MqoQx8OauocBALUW0tjcWEBqeQyitU/w6bOr+HJ2D+xkBjEpU/n1HepdQVoY3MLmdei98J5rKWWcPI734NLBI9PpVDIQUOTh5paF8lFjxF5zIhQJDDLLsC1dTyWLoEza5ibNsBe7CXkD3wTmZ2bkI3w0Tw6Ra6D2vWSNba3cSLpmF100LoGxKocRGK1OPf2m3j+yLcQCnPXpSKbSdaNGz2CMSNJ0281tbJfRDa9gsR8Qmv+yxdO4avPHsPy6jYc+SSEYpCBZAsKLAW3uKQkN9yUP6b6t+wPmWW4gSBe//vfMDNZYFRFahoiwjwUdpkRB3UbPGSzK5idnMTESBypxRReeenneO5HL2DL7u1obA7BI3hp6JIA8o+/oF65Eqd2jCaAtg3mrr5pI2bHi0jOM+oGAXQRDpMzM1LIFXB/ahpLiSQfSuKwmnMdNm3ZiiCVxKfEIj87SihcyPuGz1NuiaJPQli9nALy+XWTmyO9yKQ9zIwXMHInj5ltryJX/RPJGVZXVlGoYp3rztCmmQT4blCnAiyBWT9mVkKWEfdYAg5B1ck34Mal+yrSSygSRe87L2tEmTPnUfxpO7InnpWCKFSh+xjWjh5D4ct/MEa+P8W2YL47Y7Huu3QKJF3lbF/LAU9l2OFMt4y9PQdRfO1ddHW6iPHds1Sy5CbLkW8Io/DkNoS2vA7PHTPRqyUvQsjPsmRFWGvGuTBNqDrrVFWfslPTssGfDDeA/btcbCChgDowYr0KeS68CgeZjmqkAl0o5thevortL5evbdUUDn60rsejZYdmTjbFGX+ic2uO/cBs9HMOmYLpvrmIkijLCVKvuj45HETflQBWFlyeHhVRSWaJ3wcQAW1Lj2K991kJuOjJl8pv+Fzw+PO3FE8oC65clLQsVCAyszg5wH4acHCczxQRKUGx4TD5MutSnmxKrCMLqGSoq0A+KWMqQoNb7lz3qCw0xOdZeVoalrolsnL90pPQCl1BFCBRt1Gpqbmo47J70bFkS+JygYDLPWe+eh8AF32/qsY0kI1j/5KHJ1hzaXLFVyZmXwSPEHtYUBatNa3iR8zedB57+EYM5P/zQGBagqXFLMZGJxGrqUb9/Cz2pw6gjR8l91i/myE2oeCLN2WkwfiMROYLrcSPVm6radNO4M5EArXJTwh+EWtrOUzP+W8x6mgJxMVff/8+Dh0ewqGv70NrWwZNmTDqlg+gvSaGESHCsy9ElMcDmCKRmvu1JYEqijoyBF4Q4GsI5j/AajqH8ekURqdXkVzhS8kf5Y8T9P1rCB9dHMRTh3eQSDdat2fQmA2jnkTaYj4RZiQjmDJIxHS0YaTABDLA6xHfm01hZMoAF1iO8myaUyBp0/+JSEYd9F0c0t+hw50mI0KEGalf7kE7iQzzcf+Rplp8eYh4hVKqaxav8rPrA6wx9eMzy4x4TSPmJyUbkG9U2gl/gZN1oKG664wEY1nJaZANGWMjCfR9eBvJ5XlEq0KoiSQRy46hOd2IXatJ1EYWkRyfxWPRGNpX7iCa+ge/lu5iZGIJN4cWEZ9JM/VFdS0Xe/7Fu5CQDAYaqrrOSBQWVKTyFVQaXI7dS+DyvweQXJrnh2sIsUoSqVxAY2MDXH5kBLLDSK/dexCY3w9Fplt7w/dfjmMhNAPKjEBWWZiVhqz5k8wIkb4PSUQyEg0hEq3EFE/P7f9O4uagHzGB9SRqiMaLDc7O5f7X/2dESjb9Olstn4zIZIgTq3fw0HbMTSYwOrIE6S0dnG2kYiKRWn1fw6h5edqs4n/8CeEk8WcpRQAAAABJRU5ErkJggg=="),
        // Please specify the base64 content of a 80x80 pixels image
        ExportMetadata("BigImageBase64", "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"),
        ExportMetadata("BackgroundColor", "Lavender"),
        ExportMetadata("PrimaryFontColor", "Black"),
        ExportMetadata("SecondaryFontColor", "Gray")]
    public class MyPlugin : PluginBase
    {
        public override IXrmToolBoxPluginControl GetControl()
        {
            return new SolutionReplicatorControl();
        }

        /// <summary>
        /// Constructor 
        /// </summary>
        public MyPlugin()
        {
            // If you have external assemblies that you need to load, uncomment the following to 
            // hook into the event that will fire when an Assembly fails to resolve
            // AppDomain.CurrentDomain.AssemblyResolve += new ResolveEventHandler(AssemblyResolveEventHandler);
        }

        /// <summary>
        /// Event fired by CLR when an assembly reference fails to load
        /// Assumes that related assemblies will be loaded from a subfolder named the same as the Plugin
        /// For example, a folder named Sample.XrmToolBox.MyPlugin 
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="args"></param>
        /// <returns></returns>
        private Assembly AssemblyResolveEventHandler(object sender, ResolveEventArgs args)
        {
            Assembly loadAssembly = null;
            Assembly currAssembly = Assembly.GetExecutingAssembly();

            // base name of the assembly that failed to resolve
            var argName = args.Name.Substring(0, args.Name.IndexOf(","));

            // check to see if the failing assembly is one that we reference.
            List<AssemblyName> refAssemblies = currAssembly.GetReferencedAssemblies().ToList();
            var refAssembly = refAssemblies.Where(a => a.Name == argName).FirstOrDefault();

            // if the current unresolved assembly is referenced by our plugin, attempt to load
            if (refAssembly != null)
            {
                // load from the path to this plugin assembly, not host executable
                string dir = Path.GetDirectoryName(currAssembly.Location).ToLower();
                string folder = Path.GetFileNameWithoutExtension(currAssembly.Location);
                dir = Path.Combine(dir, folder);

                var assmbPath = Path.Combine(dir, $"{argName}.dll");

                if (File.Exists(assmbPath))
                {
                    loadAssembly = Assembly.LoadFrom(assmbPath);
                }
                else
                {
                    throw new FileNotFoundException($"Unable to locate dependency: {assmbPath}");
                }
            }

            return loadAssembly;
        }
    }
}